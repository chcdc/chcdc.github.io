
<!DOCTYPE html>
<html lang="pt_br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/monokai.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://blog.chcdc.com.br/feeds.atom" type="application/atom+xml" rel="alternate" title="Carlos Carvalho Atom">

    <link href="https://blog.chcdc.com.br/feeds.rss" type="application/rss+xml" rel="alternate" title="Carlos Carvalho RSS">

    <link rel="shortcut icon" href="https://blog.chcdc.com.br/extra/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://blog.chcdc.com.br/extra/favicon.ico" type="image/x-icon">

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-66134049-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->  


<meta name="author" content="Carlos Carvalho" />
<meta name="description" content="OpenVPN √© uma aplica√ß√£o VPN de c√≥digo aberto que permite criar e participar de uma rede privada de forma segura atrav√©s da Internet p√∫blica. Vamos instalar e configurar o OpenVPN em um servidor CentOS 7. Levando em considera√ß√£o que o servidor Linux baseado na distribui√ß√£o CentOS 7 esteja devidamente instalado ‚Ä¶" />
<meta name="keywords" content="sysadmin, VPN, Linux">


<meta property="og:site_name" content="Carlos Carvalho"/>
<meta property="og:title" content="OpenVPN"/>
<meta property="og:description" content="OpenVPN √© uma aplica√ß√£o VPN de c√≥digo aberto que permite criar e participar de uma rede privada de forma segura atrav√©s da Internet p√∫blica. Vamos instalar e configurar o OpenVPN em um servidor CentOS 7. Levando em considera√ß√£o que o servidor Linux baseado na distribui√ß√£o CentOS 7 esteja devidamente instalado ‚Ä¶"/>
<meta property="og:locale" content="pt_BR"/>
<meta property="og:url" content="../../posts/openvpn"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-05-20 00:00:00-03:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="../../author/">
<meta property="article:section" content="Network"/>
<meta property="article:tag" content="sysadmin"/>
<meta property="article:tag" content="VPN"/>
<meta property="article:tag" content="Linux"/>
<meta property="og:image" content="">

  <title>Carlos Carvalho &ndash; OpenVPN</title>

</head>
<body >
  <aside>
    <div>
      <a href="../..">
        <img src="https://s.gravatar.com/avatar/b29f6fb12e1e61f1d2a46e1ec2834696?s=80" alt="Carlos Carvalho" title="Carlos Carvalho">
      </a>

      <h1>
        <a href="../..">Carlos Carvalho</a>
      </h1>

<p>Yet Another Blog</p>


      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/chcdc" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="https://pt.stackoverflow.com/users/26828" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="http://blog.chcdc.com.br/feeds/all-pt.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/chcdc/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../..">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://blog.chcdc.com.br/feeds.atom">Atom</a>

      <a href="https://blog.chcdc.com.br/feeds.rss">RSS</a>
    </nav>

<article class="single">
  <header>
      
    <h1 id="openvpn">OpenVPN</h1>
    <p>
      Posted on Mon 20 May 2019 in <a href="../../category/network">Network</a>

        &#8226; 7 min read
    </p>
  </header>


  <div>
    <p>OpenVPN √© uma aplica√ß√£o VPN de c√≥digo aberto que permite criar e participar de uma rede privada de forma segura atrav√©s da Internet p√∫blica.</p>
<p>Vamos instalar e configurar o OpenVPN em um servidor CentOS 7.</p>
<p>Levando em considera√ß√£o que o servidor Linux baseado na distribui√ß√£o CentOS 7 esteja devidamente instalado e com a rede configurada, vamos iniciar a instala√ß√£o.</p>
<!--more-->
<h3 id="configurando-o-sistema">Configurando o sistema</h3>
<p>Desabilite o SELinux</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>sed -i <span class="s1">&#39;s/^SELINUX=.*/SELINUX=disabled/g&#39;</span> /etc/sysconfig/selinux <span class="o">&amp;&amp;</span> cat /etc/sysconfig/selinux 
</code></pre></div>

<p>Desabilite o firewalld</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>systemctl stop firewalld
<span class="gp"># </span>systemctl disable firewalld
</code></pre></div>

<p>Ap√≥s as altera√ß√µes reinicie o sistema para aplicar a configura√ß√£o</p>
<p>Ajuste o kernel para habilitar o modo de roteamento:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span><span class="nb">echo</span> net.ipv4.ip_forward <span class="o">=</span> <span class="m">1</span> &gt;&gt; /etc/sysctl.conf
<span class="gp"># </span>sysctl -p
</code></pre></div>

<p>Atualize o sistema operacional</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>yum upgrade -y
</code></pre></div>

<h3 id="instalando-openvpn">Instalando OpenVPN</h3>
<p>O reposit√≥rio Extra Packages for Enterprise Linux (EPEL) √© um reposit√≥rio adicional gerenciado pelo Projeto Fedora contendo pacotes n√£o padr√£o, mas populares. O OpenVPN n√£o est√° dispon√≠vel nos reposit√≥rios padr√£o do CentOS, mas est√° dispon√≠vel no EPEL, ent√£o instale o EPEL:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>yum install epel-release -y <span class="o">&amp;&amp;</span> yum update -y
</code></pre></div>

<p>Pr√≥ximo passo √© instalar os pacotes necess√°rios</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>yum install openvpn vim -y
</code></pre></div>

<p>Usando o curl, fa√ßa o download do Easy RSA. 
Recomendo o uso do easy-rsa-2, pois h√° mais documenta√ß√£o dispon√≠vel para esta vers√£o. </p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>curl -L https://github.com/OpenVPN/easy-rsa-old/archive/2.3.3.tar.gz -o /tmp/easyrsa.tar.gz
</code></pre></div>

<p>Extraia o pacote e crie o diret√≥rio em /etc/openvpn/</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>tar xfz /tmp/easyrsa.tar.gz
<span class="gp"># </span>sudo mkdir /etc/openvpn/easy-rsa 
<span class="gp"># </span>sudo mkdir /etc/openvpn/keys
</code></pre></div>

<p>Copie a estrutura do diret√≥rio easy-rsa para o diret√≥rio /etc/openvpn/easy-rsa para facilitar a administra√ß√£o:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>sudo cp -rfv easy-rsa-old-2.3.3/easy-rsa/2.0/* /etc/openvpn/easy-rsa/
</code></pre></div>

<p>Altere o diret√≥rio para um usu√°rio n√£o root</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>chown <span class="s2">&quot;user&quot;</span> /etc/openvpn/easy-rsa/
</code></pre></div>

<p>Depois que esses programas forem instalados e tiverem sido movidos para os locais corretos em seu sistema, a pr√≥xima etapa √© personalizar a configura√ß√£o do lado do servidor do OpenVPN.</p>
<h3 id="configurando-openvpn">Configurando OpenVPN</h3>
<p>Temos muitas formas de configurar o OpenVPN, neste documento vamos fazer a forma mais comum de conex√£o.</p>
<p>Crie o arquivo de configura√ß√£o</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>vim /etc/openvpn/server.conf
</code></pre></div>

<p>Vamos a Configura√ß√£o</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>IP <span class="k">do</span> servidor VPN
<span class="go">local xxx.xxx.xxx.xxx</span>

<span class="gp"># </span>Porta Utilizada
<span class="go">port 1194</span>

<span class="gp"># </span>Protocolo de Conex√£o e porta utilizada
<span class="go">proto udp </span>
<span class="go">dev tun0 </span>

<span class="gp"># </span>Permite que o t√∫nel <span class="k">continue</span> aberto mesmo que o endere√ßo IP da outra m√°quina mude
<span class="go">float</span>

<span class="gp">#</span><span class="c1"># Localiza√ß√£o das Chaves e certificados</span>
<span class="go">ca /etc/openvpn/keys/ca.crt </span>
<span class="go">cert /etc/openvpn/keys/server.crt</span>
<span class="go">key /etc/openvpn/keys/server.key  # This file should be kept secret</span>
<span class="go">dh /etc/openvpn/keys/dh2048.pem</span>

<span class="gp"># </span>Configura o OpenVPN para funcionar como uma 
<span class="gp"># </span>sub-rede e informa √† m√°quina cliente qual endere√ßo utilizar
<span class="go">topology subnet</span>

<span class="gp"># </span>Configura√ß√£o <span class="k">do</span> endere√ßo <span class="k">do</span> servidor
<span class="go">server 10.1.1.0 255.255.255.0 </span>

<span class="gp">#</span>Configura√ß√£o para manter os endere√ßos est√°ticos dos clientes, 
<span class="gp"># </span>caso o OpenVPN reinicie, 
<span class="gp"># </span>poder√° ser atribu√≠do aos clientes de reconex√£o o mesmo endere√ßo IP
<span class="go">ifconfig-pool-persist ipp.txt</span>

<span class="gp"># </span>Informa a configura√ß√£o de cada cliente
<span class="go">client-config-dir /etc/openvpn/ccd/</span>

<span class="gp"># </span>Configura√ß√£o para setar o DNS dos clientes, no exemplo abaixo estamos utilizando o opendns.com
<span class="go">push &quot;dhcp-option DNS 208.67.222.222&quot;</span>
<span class="go">push &quot;dhcp-option DNS 208.67.220.220&quot;</span>

<span class="gp"># </span>Envia um ‚Äúping‚Äù de um lado para o outro, 
<span class="gp"># </span>de modo que cada lado saiba quando o outro lado ficou inativo.
<span class="gp"># </span>Ping a cada <span class="m">10</span> segundos, declara como inativo se nenhum ping <span class="k">for</span> recebido 
<span class="gp"># </span>durante um tempo de <span class="m">120</span> segundos
<span class="go">keepalive 10 120</span>


<span class="gp"># </span>Chave de seguran√ßa Cipher. Deve conter no arquivo cliente e servidor.
<span class="go">cipher AES-256-CBC</span>

<span class="gp"># </span>Compacta√ß√£o 
<span class="go">comp-lzo</span>

<span class="gp"># </span>Quantidade maxima de clientes 
<span class="go">max-clients 10</span>

<span class="gp"># </span>Op√ß√µes Persistentes
<span class="go">persist-key</span>
<span class="go">persist-tun</span>

<span class="gp"># </span>Arquivo de status curto, exibindo as conex√µes atuais, truncadas e reescrito a cada minuto
<span class="go">status /var/log/openvpn-status.log</span>

<span class="gp"># </span>Log OpenVPN
<span class="go">log-append  /var/log/openvpn.log</span>
<span class="go">verb 3</span>

<span class="gp"># </span>Notificar o cliente que quando o servidor <span class="k">for</span> reiniciado pode reconectar-se automaticamente.
<span class="go">explicit-exit-notify 1</span>
</code></pre></div>

<h3 id="gerando-chaves-e-certificados-servidor">Gerando Chaves e certificados Servidor</h3>
<p>Come√ßaremos nosso processo de gera√ß√£o de chaves e certificados criando um diret√≥rio no qual o Easy RSA armazenar√° todas as chaves e certificados gerados:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>mkdir /etc/openvpn/easy-rsa/keys
</code></pre></div>

<p>Vamos editar as vari√°veis padr√µes que ficam no arquivo <strong>vars</strong> em <strong>/etc/openvpn/easy-rsa/</strong> :</p>
<p>V√° at√© o final do arquivo e altere os valores abaixo</p>
<p>KEY_NAME: O nome do servidor, o mesmo utilizado para a cria√ß√£o das chaves "server.key" e "server.crt"<br />
export KEY_COUNTRY="BR"<br />
export KEY_PROVINCE="PR"<br />
export KEY_CITY="Maringa"<br />
export KEY_ORG="Empresa"<br />
export KEY_EMAIL="vpn@company.com.br"<br />
export KEY_CN=openvpn<br />
export KEY_NAME="server"<br />
export KEY_OU="Infraestrutura"<br /></p>
<p>Salve e feche o arquivo</p>
<p>Para come√ßar a gerar as chaves e os certificados, v√° para o diret√≥rio easy-rsa e carregue as vari√°veis declaradas no arquivo vars na mem√≥ria:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /etc/openvpn/easy-rsa
<span class="gp"># </span><span class="nb">source</span> ./vars
</code></pre></div>

<p>Execute o script clean-all do Easy RSA para remover todas as chaves e certificados j√° existentes na pasta e gerar a autoridade de certifica√ß√£o:</p>
<p><strong>LEMBRE-SE: esse comando remove todas as chaves e certificados j√° criados. N√£o o execute em produ√ß√£o</strong></p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>./clean-all
</code></pre></div>

<p>Este script gera um arquivo chamado ca.key. Essa √© a chave privada usada para assinar seu servidor e os certificados dos clientes. Se estiver perdido, voc√™ n√£o poder√° mais confiar em nenhum certificado dessa autoridade de certifica√ß√£o e, se algu√©m conseguir acessar esse arquivo, poder√° assinar novos certificados e acessar sua VPN sem o seu conhecimento. 
Por esse motivo, o OpenVPN recomenda armazenar o ca.key em um local que possa estar offline o m√°ximo poss√≠vel e s√≥ deve ser ativado ao criar novos certificados.</p>
<p>Em seguida, construa a autoridade de certifica√ß√£o com o script build-ca. Voc√™ ser√° solicitado a inserir valores para os campos de certificado, mas se voc√™ definir as vari√°veis no arquivo vars anteriormente, todas as suas op√ß√µes j√° estar√£o definidas como padr√µes. Voc√™ pode pressionar ENTER para aceitar os padr√µes de cada um:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>./build-ca
</code></pre></div>

<p>Gere a chave de criptografia est√°tica com o seguinte comando:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>openvpn --genkey --secret /etc/openvpn/keys/vpn_server.tlsauth
</code></pre></div>

<p>Em seguida, crie uma chave e um certificado para o servidor usando o script build-key-server:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>./build-key-server server
</code></pre></div>

<p>Assim como na cria√ß√£o da autoridade de certifica√ß√£o, voc√™ ver√° os valores que definiu como padr√£o para poder pressionar ENTER nesses prompts. Al√©m disso, voc√™ ser√° solicitado a inserir uma senha de desafio e um nome de empresa opcional. Se voc√™ digitar uma senha de desafio, voc√™ ser√° solicitado a se conectar √† VPN do seu cliente. Se voc√™ n√£o quiser definir uma senha de desafio, deixe esta linha em branco e pressione ENTER. No final, insira Y para confirmar as altera√ß√µes.</p>
<p>A √∫ltima parte da cria√ß√£o das chaves e dos certificados do servidor est√° gerando um arquivo de troca de chaves Diffie-Hellman. Use o script build-dh para fazer isso. Isso pode levar alguns minutos para ser conclu√≠do</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>./build-dh
</code></pre></div>

<p>Quando o servidor terminar de gerar o arquivo de troca de chaves, copie as chaves do servidor e os certificados do diret√≥rio keys no diret√≥rio openvpn:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /etc/openvpn/easy-rsa/keys/
<span class="gp"># </span>sudo cp dh2048.pem ca.crt server.crt server.key /etc/openvpn/keys
</code></pre></div>

<h3 id="gerando-chaves-e-certificados-cliente">Gerando Chaves e certificados Cliente</h3>
<p>Cada cliente tamb√©m precisar√° de um certificado para que o servidor OpenVPN possa autentic√°-lo. Essas chaves e certificados ser√£o criados no servidor e voc√™ ter√° que copi√°-los para seus clientes. √â aconselh√°vel gerar chaves e certificados separados para cada cliente que voc√™ pretende conectar √† sua VPN.</p>
<p>Crie um certificado de cliente teste. N√£o crie um certificado para ser utilizado futuramente, pois o mesmo ser√° utilizado para criar o arquivo de revoga√ß√£o de certificados e ser√° invalidado logo em seguida. Preste aten√ß√£o em alterar o endere√ßo de email para cada certificado novo:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span><span class="nb">cd</span> /etc/openvpn/easy-rsa/
<span class="gp"># </span>./build-key cert-test
</code></pre></div>

<p>Revogue o certificado teste, criado anteriormente, para gerar o arquivo crl.pem, que ser√° respons√°vel por controlar os certificados revogados.</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>./revoke-full cert-teste
</code></pre></div>

<p>Sempre que um certificado for revogado, o arquivo crl.pem dever√° ser copiado para a raiz do servidor OpenVPN para que o mesmo possa ser lido:</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>cp /etc/openvpn/rsa/keys/crl.pem /etc/openvpn
</code></pre></div>

<p>Agora vamos criar o certificado, como vamos apenas criar esse, vamos nome√°-lo de client , mas voc√™ pode alterar isso para um nome mais descritivo se quiser:</p>
<div class="highlight"><pre><span></span><code><span class="gp">$ </span><span class="nb">cd</span> /etc/openvpn/easy-rsa/
<span class="gp">$ </span>./build-key client
</code></pre></div>

<p>Copie o arquivo de configura√ß√£o do OpenSSL com vers√£o, openssl-1.0.0.cnf, para um nome sem vers√£o, openssl.cnf. N√£o fazer isso pode resultar em um erro em que o OpenSSL n√£o consegue carregar a configura√ß√£o porque n√£o pode detectar sua vers√£o</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>cp /etc/openvpn/easy-rsa/openssl-1.0.0.cnf /etc/openvpn/easy-rsa/openssl.cnf
</code></pre></div>

<h3 id="iniciando-openvpn">Iniciando OpenVPN</h3>
<p>Vamos configurar o OpenVPN para iniciar na inicializa√ß√£o. Para fazer isso, ative o servidor OpenVPN adicionando-o ao systemctl</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>sudo systemctl -f <span class="nb">enable</span> openvpn@server.service
</code></pre></div>

<p>Inicie o servi√ßo</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>sudo systemctl start openvpn@server.service
</code></pre></div>

<p>Verifique se n√£o houve erros durante a inicializa√ß√£o do servi√ßo. Caso tenha erros, verifique o arquivo de log /var/log/openvpn.log</p>
<h3 id="criando-rotas-estaticas">Criando rotas estaticas</h3>
<p>Vamos criar para cada cliente uma configura√ß√£o de rede individual</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>mkdir /etc/openvpn/ccd
</code></pre></div>

<p>Dentro do diret√≥rio, crie um arquivo com o nome exatamente igual ao que foi gerado o certificado, no nosso caso √© client</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>touch /etc/openvpn/ccd/client
</code></pre></div>

<p>Vamos inserir as informa√ß√µes necess√°rias.</p>
<p>[Optional]
Caso deseja que cada cliente tenha um endere√ßo setado manualmente, insira no inicio do arquivo</p>
<div class="highlight"><pre><span></span><code><span class="go">ifconfig-push 10.1.1.1 255.255.255.0 </span>
</code></pre></div>

<p>[/optional]</p>
<p>Insira as rotas da rede local e a rede openvpn, caso deseja que ele acesse a mesma</p>
<div class="highlight"><pre><span></span><code><span class="go">push &quot;route 10.1.1.0 255.255.255.0&quot;</span>
<span class="go">push &quot;route 10.42.12.0 255.255.254.0&quot;</span>
</code></pre></div>

<p>Insira as rotas desejadas, sempre comentando o destino </p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span>Algum lugar <span class="k">do</span> mundo
<span class="go">push &quot;route 200.200.200.1 255.255.255.0&quot;</span>
</code></pre></div>

<h3 id="configurando-o-firewall">Configurando o Firewall</h3>
<p>Para que o servidor fa√ßa os redirecionamentos necess√°rios e aceite conex√µes precisamos setar isso no iptables</p>
<p>Execute os seguintes comandos</p>
<div class="highlight"><pre><span></span><code><span class="gp"># </span><span class="nb">echo</span> <span class="m">1</span> &gt; /proc/sys/net/ipv4/ip_forward
<span class="gp"># </span>iptables -P FORWARD ACCEPT
<span class="gp"># </span>iptables -A INPUT -i tun+ -j ACCEPT
<span class="gp"># </span>iptables -A FORWARD -i tun+ -j ACCEPT
<span class="gp"># </span>iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE
<span class="gp"># </span>iptables -A FORWARD -i tun0 -o tun0 -j ACCEPT
<span class="gp"># </span>iptables -A FORWARD -i tun0 -o ens32 -j ACCEPT
<span class="gp"># </span>iptables -A FORWARD -i ens32 -o tun0 -j ACCEPT
<span class="gp"># </span>iptables -A INPUT -p tcp --dport <span class="m">1194</span> -j ACCEPT
<span class="gp"># </span>iptables -A INPUT -p udp --dport <span class="m">1194</span> -j ACCEPT
<span class="gp"># </span>iptables -I INPUT -i tun+ -j ACCEPT
<span class="gp"># </span>iptables -I OUTPUT -o tun+ -j ACCEPT
<span class="gp"># </span>iptables -I FORWARD -i tun+ -j ACCEPT
<span class="gp"># </span>iptables -I FORWARD -o tun+ -j ACCEPT
</code></pre></div>

<h3 id="configurando-o-cliente">Configurando o Cliente</h3>
<p>Os certificados e chave que ser√£o inseridos no final do arquivo se encontram em /etc/openvpn/easy-rsa/keys/
Sendo eles
    * ca - ca.crt 
    * cert - client.crt
    * key - client.key</p>
<p>Crie o arquivo client.ovpn com as seguintes configura√ß√µes</p>
<div class="highlight"><pre><span></span><code><span class="go">client</span>
<span class="go">pull</span>
<span class="go">dev tun</span>
<span class="go">proto udp</span>
<span class="go">remote &lt;ip external&gt; 1194 udp</span>
<span class="go">user nobody</span>
<span class="go">group nogroup</span>
<span class="go">comp-lzo</span>
<span class="go">verb 3</span>
<span class="go">resolv-retry infinite</span>
<span class="go">persist-key</span>
<span class="go">persist-tun</span>
<span class="go">mute-replay-warnings</span>
<span class="go">auth-nocache</span>
<span class="go">float</span>

<span class="gp"># </span>Ciphers
<span class="go">remote-cert-tls server</span>
<span class="go">tls-version-min 1.2</span>
<span class="go">tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384</span>
<span class="go">cipher AES-256-CBC</span>

<span class="gp"># </span>Client Keys
<span class="go">&lt;ca&gt;</span>
<span class="go">-----BEGIN CERTIFICATE-----</span>
<span class="go">-----END CERTIFICATE-----</span>
<span class="go">&lt;/ca&gt;</span>
<span class="go">&lt;cert&gt;</span>
<span class="go">-----BEGIN CERTIFICATE-----</span>
<span class="go">-----END CERTIFICATE-----</span>
<span class="go">&lt;/cert&gt;</span>
<span class="go">&lt;key&gt;</span>
<span class="go">-----BEGIN RSA PRIVATE KEY-----</span>
<span class="go">-----END RSA PRIVATE KEY-----</span>
<span class="go">&lt;/key&gt;</span>
</code></pre></div>

<p>Copie o arquivo para sua m√°quina local, pode utilizar sftp ou scp. </p>
<p>Ap√≥s seguir esses passos, sua vpn dever√° estar j√° criada e acess√≠vel. Realize os testes de acesso, sempre verificando os logs.</p>
<p>Simples Assim üòÜ</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/sysadmin">sysadmin</a>
      <a href="../../tag/vpn">VPN</a>
      <a href="../../tag/linux">Linux</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../posts/dicas-iptables" title="Dicas IPTables">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../posts/migrando-repositorios-do-svn-para-o-git" title="Migrando repositorios do SVN para o GIT">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="../../posts/dicas-iptables">Dicas IPTables</a></li>
      <li><a href="../../posts/permissoes-no-linux">Permissoes no Linux</a></li>
      <li><a href="../../posts/registro-de-acesso">Registro de acesso</a></li>
      <li><a href="../../posts/removendo-varios-arquivos-de-uma-lista-gigante">Removendo v√°rios arquivos de uma lista gigante</a></li>
      <li><a href="../../posts/ipsec-strongswan">IPSec StrongSwan</a></li>
    </ul>
  </div>


<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'chcdc';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy; 2021 Carlos Carvalho</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Carlos Carvalho ",
  "url" : "../..",
  "image": "",
  "description": "Yet Another Blog"
}
</script>

</body>
</html>