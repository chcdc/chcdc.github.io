<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Carlos Carvalho - Network</title><link href="https://blog.chcdc.com.br/" rel="alternate"></link><link href="https://blog.chcdc.com.br/feeds/network.atom" rel="self"></link><id>https://blog.chcdc.com.br/</id><updated>2019-05-20T00:00:00-03:00</updated><entry><title>OpenVPN</title><link href="https://blog.chcdc.com.br/posts/openvpn" rel="alternate"></link><published>2019-05-20T00:00:00-03:00</published><updated>2019-05-20T00:00:00-03:00</updated><author><name>Carlos Carvalho</name></author><id>tag:blog.chcdc.com.br,2019-05-20:/posts/openvpn</id><summary type="html">&lt;p&gt;OpenVPN √© uma aplica√ß√£o VPN de c√≥digo aberto que permite criar e participar de uma rede privada de forma segura atrav√©s da Internet p√∫blica.&lt;/p&gt;
&lt;p&gt;Vamos instalar e configurar o OpenVPN em um servidor CentOS 7.&lt;/p&gt;
&lt;p&gt;Levando em considera√ß√£o que o servidor Linux baseado na distribui√ß√£o CentOS 7 esteja devidamente instalado ‚Ä¶&lt;/p&gt;</summary><content type="html">&lt;p&gt;OpenVPN √© uma aplica√ß√£o VPN de c√≥digo aberto que permite criar e participar de uma rede privada de forma segura atrav√©s da Internet p√∫blica.&lt;/p&gt;
&lt;p&gt;Vamos instalar e configurar o OpenVPN em um servidor CentOS 7.&lt;/p&gt;
&lt;p&gt;Levando em considera√ß√£o que o servidor Linux baseado na distribui√ß√£o CentOS 7 esteja devidamente instalado e com a rede configurada, vamos iniciar a instala√ß√£o.&lt;/p&gt;
&lt;!--more--&gt;

&lt;h3&gt;Configurando o sistema&lt;/h3&gt;
&lt;p&gt;Desabilite o SELinux&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; sed -i &lt;span class="s1"&gt;&amp;#39;s/^SELINUX=.*/SELINUX=disabled/g&amp;#39;&lt;/span&gt; /etc/sysconfig/selinux &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; cat /etc/sysconfig/selinux 
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Desabilite o firewalld&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; systemctl stop firewalld
&lt;span class="gp"&gt;#&lt;/span&gt; systemctl disable firewalld
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Ap√≥s as altera√ß√µes reinicie o sistema para aplicar a configura√ß√£o&lt;/p&gt;
&lt;p&gt;Ajuste o kernel para habilitar o modo de roteamento:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; net.ipv4.ip_forward &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt; &amp;gt;&amp;gt; /etc/sysctl.conf
&lt;span class="gp"&gt;#&lt;/span&gt; sysctl -p
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Atualize o sistema operacional&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; yum upgrade -y
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Instalando OpenVPN&lt;/h3&gt;
&lt;p&gt;O reposit√≥rio Extra Packages for Enterprise Linux (EPEL) √© um reposit√≥rio adicional gerenciado pelo Projeto Fedora contendo pacotes n√£o padr√£o, mas populares. O OpenVPN n√£o est√° dispon√≠vel nos reposit√≥rios padr√£o do CentOS, mas est√° dispon√≠vel no EPEL, ent√£o instale o EPEL:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; yum install epel-release -y &lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt; yum update -y
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Pr√≥ximo passo √© instalar os pacotes necess√°rios&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; yum install openvpn vim -y
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Usando o curl, fa√ßa o download do Easy RSA. 
Recomendo o uso do easy-rsa-2, pois h√° mais documenta√ß√£o dispon√≠vel para esta vers√£o. &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; curl -L https://github.com/OpenVPN/easy-rsa-old/archive/2.3.3.tar.gz -o /tmp/easyrsa.tar.gz
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Extraia o pacote e crie o diret√≥rio em /etc/openvpn/&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; tar xfz /tmp/easyrsa.tar.gz
&lt;span class="gp"&gt;#&lt;/span&gt; sudo mkdir /etc/openvpn/easy-rsa 
&lt;span class="gp"&gt;#&lt;/span&gt; sudo mkdir /etc/openvpn/keys
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Copie a estrutura do diret√≥rio easy-rsa para o diret√≥rio /etc/openvpn/easy-rsa para facilitar a administra√ß√£o:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; sudo cp -rfv easy-rsa-old-2.3.3/easy-rsa/2.0/* /etc/openvpn/easy-rsa/
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Altere o diret√≥rio para um usu√°rio n√£o root&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; chown &lt;span class="s2"&gt;&amp;quot;user&amp;quot;&lt;/span&gt; /etc/openvpn/easy-rsa/
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Depois que esses programas forem instalados e tiverem sido movidos para os locais corretos em seu sistema, a pr√≥xima etapa √© personalizar a configura√ß√£o do lado do servidor do OpenVPN.&lt;/p&gt;
&lt;h3&gt;Configurando OpenVPN&lt;/h3&gt;
&lt;p&gt;Temos muitas formas de configurar o OpenVPN, neste documento vamos fazer a forma mais comum de conex√£o.&lt;/p&gt;
&lt;p&gt;Crie o arquivo de configura√ß√£o&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; vim /etc/openvpn/server.conf
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Vamos a Configura√ß√£o&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; IP &lt;span class="k"&gt;do&lt;/span&gt; servidor VPN
&lt;span class="go"&gt;local xxx.xxx.xxx.xxx&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Porta Utilizada
&lt;span class="go"&gt;port 1194&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Protocolo de Conex√£o e porta utilizada
&lt;span class="go"&gt;proto udp &lt;/span&gt;
&lt;span class="go"&gt;dev tun0 &lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Permite que o t√∫nel &lt;span class="k"&gt;continue&lt;/span&gt; aberto mesmo que o endere√ßo IP da outra m√°quina mude
&lt;span class="go"&gt;float&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt;&lt;span class="c1"&gt;# Localiza√ß√£o das Chaves e certificados&lt;/span&gt;
&lt;span class="go"&gt;ca /etc/openvpn/keys/ca.crt &lt;/span&gt;
&lt;span class="go"&gt;cert /etc/openvpn/keys/server.crt&lt;/span&gt;
&lt;span class="go"&gt;key /etc/openvpn/keys/server.key  # This file should be kept secret&lt;/span&gt;
&lt;span class="go"&gt;dh /etc/openvpn/keys/dh2048.pem&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Configura o OpenVPN para funcionar como uma 
&lt;span class="gp"&gt;#&lt;/span&gt; sub-rede e informa √† m√°quina cliente qual endere√ßo utilizar
&lt;span class="go"&gt;topology subnet&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Configura√ß√£o &lt;span class="k"&gt;do&lt;/span&gt; endere√ßo &lt;span class="k"&gt;do&lt;/span&gt; servidor
&lt;span class="go"&gt;server 10.1.1.0 255.255.255.0 &lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt;Configura√ß√£o para manter os endere√ßos est√°ticos dos clientes, 
&lt;span class="gp"&gt;#&lt;/span&gt; caso o OpenVPN reinicie, 
&lt;span class="gp"&gt;#&lt;/span&gt; poder√° ser atribu√≠do aos clientes de reconex√£o o mesmo endere√ßo IP
&lt;span class="go"&gt;ifconfig-pool-persist ipp.txt&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Informa a configura√ß√£o de cada cliente
&lt;span class="go"&gt;client-config-dir /etc/openvpn/ccd/&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Configura√ß√£o para setar o DNS dos clientes, no exemplo abaixo estamos utilizando o opendns.com
&lt;span class="go"&gt;push &amp;quot;dhcp-option DNS 208.67.222.222&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;push &amp;quot;dhcp-option DNS 208.67.220.220&amp;quot;&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Envia um ‚Äúping‚Äù de um lado para o outro, 
&lt;span class="gp"&gt;#&lt;/span&gt; de modo que cada lado saiba quando o outro lado ficou inativo.
&lt;span class="gp"&gt;#&lt;/span&gt; Ping a cada &lt;span class="m"&gt;10&lt;/span&gt; segundos, declara como inativo se nenhum ping &lt;span class="k"&gt;for&lt;/span&gt; recebido 
&lt;span class="gp"&gt;#&lt;/span&gt; durante um tempo de &lt;span class="m"&gt;120&lt;/span&gt; segundos
&lt;span class="go"&gt;keepalive 10 120&lt;/span&gt;


&lt;span class="gp"&gt;#&lt;/span&gt; Chave de seguran√ßa Cipher. Deve conter no arquivo cliente e servidor.
&lt;span class="go"&gt;cipher AES-256-CBC&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Compacta√ß√£o 
&lt;span class="go"&gt;comp-lzo&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Quantidade maxima de clientes 
&lt;span class="go"&gt;max-clients 10&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Op√ß√µes Persistentes
&lt;span class="go"&gt;persist-key&lt;/span&gt;
&lt;span class="go"&gt;persist-tun&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Arquivo de status curto, exibindo as conex√µes atuais, truncadas e reescrito a cada minuto
&lt;span class="go"&gt;status /var/log/openvpn-status.log&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Log OpenVPN
&lt;span class="go"&gt;log-append  /var/log/openvpn.log&lt;/span&gt;
&lt;span class="go"&gt;verb 3&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Notificar o cliente que quando o servidor &lt;span class="k"&gt;for&lt;/span&gt; reiniciado pode reconectar-se automaticamente.
&lt;span class="go"&gt;explicit-exit-notify 1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Gerando Chaves e certificados Servidor&lt;/h3&gt;
&lt;p&gt;Come√ßaremos nosso processo de gera√ß√£o de chaves e certificados criando um diret√≥rio no qual o Easy RSA armazenar√° todas as chaves e certificados gerados:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; mkdir /etc/openvpn/easy-rsa/keys
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Vamos editar as vari√°veis padr√µes que ficam no arquivo &lt;strong&gt;vars&lt;/strong&gt; em &lt;strong&gt;/etc/openvpn/easy-rsa/&lt;/strong&gt; :&lt;/p&gt;
&lt;p&gt;V√° at√© o final do arquivo e altere os valores abaixo&lt;/p&gt;
&lt;p&gt;KEY_NAME: O nome do servidor, o mesmo utilizado para a cria√ß√£o das chaves "server.key" e "server.crt"&lt;br /&gt;
export KEY_COUNTRY="BR"&lt;br /&gt;
export KEY_PROVINCE="PR"&lt;br /&gt;
export KEY_CITY="Maringa"&lt;br /&gt;
export KEY_ORG="Empresa"&lt;br /&gt;
export KEY_EMAIL="vpn@company.com.br"&lt;br /&gt;
export KEY_CN=openvpn&lt;br /&gt;
export KEY_NAME="server"&lt;br /&gt;
export KEY_OU="Infraestrutura"&lt;br /&gt;&lt;/p&gt;
&lt;p&gt;Salve e feche o arquivo&lt;/p&gt;
&lt;p&gt;Para come√ßar a gerar as chaves e os certificados, v√° para o diret√≥rio easy-rsa e carregue as vari√°veis declaradas no arquivo vars na mem√≥ria:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn/easy-rsa
&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;source&lt;/span&gt; ./vars
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Execute o script clean-all do Easy RSA para remover todas as chaves e certificados j√° existentes na pasta e gerar a autoridade de certifica√ß√£o:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;LEMBRE-SE: esse comando remove todas as chaves e certificados j√° criados. N√£o o execute em produ√ß√£o&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; ./clean-all
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Este script gera um arquivo chamado ca.key. Essa √© a chave privada usada para assinar seu servidor e os certificados dos clientes. Se estiver perdido, voc√™ n√£o poder√° mais confiar em nenhum certificado dessa autoridade de certifica√ß√£o e, se algu√©m conseguir acessar esse arquivo, poder√° assinar novos certificados e acessar sua VPN sem o seu conhecimento. 
Por esse motivo, o OpenVPN recomenda armazenar o ca.key em um local que possa estar offline o m√°ximo poss√≠vel e s√≥ deve ser ativado ao criar novos certificados.&lt;/p&gt;
&lt;p&gt;Em seguida, construa a autoridade de certifica√ß√£o com o script build-ca. Voc√™ ser√° solicitado a inserir valores para os campos de certificado, mas se voc√™ definir as vari√°veis no arquivo vars anteriormente, todas as suas op√ß√µes j√° estar√£o definidas como padr√µes. Voc√™ pode pressionar ENTER para aceitar os padr√µes de cada um:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; ./build-ca
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Gere a chave de criptografia est√°tica com o seguinte comando:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; openvpn --genkey --secret /etc/openvpn/keys/vpn_server.tlsauth
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Em seguida, crie uma chave e um certificado para o servidor usando o script build-key-server:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; ./build-key-server server
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Assim como na cria√ß√£o da autoridade de certifica√ß√£o, voc√™ ver√° os valores que definiu como padr√£o para poder pressionar ENTER nesses prompts. Al√©m disso, voc√™ ser√° solicitado a inserir uma senha de desafio e um nome de empresa opcional. Se voc√™ digitar uma senha de desafio, voc√™ ser√° solicitado a se conectar √† VPN do seu cliente. Se voc√™ n√£o quiser definir uma senha de desafio, deixe esta linha em branco e pressione ENTER. No final, insira Y para confirmar as altera√ß√µes.&lt;/p&gt;
&lt;p&gt;A √∫ltima parte da cria√ß√£o das chaves e dos certificados do servidor est√° gerando um arquivo de troca de chaves Diffie-Hellman. Use o script build-dh para fazer isso. Isso pode levar alguns minutos para ser conclu√≠do&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; ./build-dh
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Quando o servidor terminar de gerar o arquivo de troca de chaves, copie as chaves do servidor e os certificados do diret√≥rio keys no diret√≥rio openvpn:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn/easy-rsa/keys/
&lt;span class="gp"&gt;#&lt;/span&gt; sudo cp dh2048.pem ca.crt server.crt server.key /etc/openvpn/keys
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Gerando Chaves e certificados Cliente&lt;/h3&gt;
&lt;p&gt;Cada cliente tamb√©m precisar√° de um certificado para que o servidor OpenVPN possa autentic√°-lo. Essas chaves e certificados ser√£o criados no servidor e voc√™ ter√° que copi√°-los para seus clientes. √â aconselh√°vel gerar chaves e certificados separados para cada cliente que voc√™ pretende conectar √† sua VPN.&lt;/p&gt;
&lt;p&gt;Crie um certificado de cliente teste. N√£o crie um certificado para ser utilizado futuramente, pois o mesmo ser√° utilizado para criar o arquivo de revoga√ß√£o de certificados e ser√° invalidado logo em seguida. Preste aten√ß√£o em alterar o endere√ßo de email para cada certificado novo:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn/easy-rsa/
&lt;span class="gp"&gt;#&lt;/span&gt; ./build-key cert-test
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Revogue o certificado teste, criado anteriormente, para gerar o arquivo crl.pem, que ser√° respons√°vel por controlar os certificados revogados.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; ./revoke-full cert-teste
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Sempre que um certificado for revogado, o arquivo crl.pem dever√° ser copiado para a raiz do servidor OpenVPN para que o mesmo possa ser lido:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; cp /etc/openvpn/rsa/keys/crl.pem /etc/openvpn
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Agora vamos criar o certificado, como vamos apenas criar esse, vamos nome√°-lo de client , mas voc√™ pode alterar isso para um nome mais descritivo se quiser:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;$&lt;/span&gt; &lt;span class="nb"&gt;cd&lt;/span&gt; /etc/openvpn/easy-rsa/
&lt;span class="gp"&gt;$&lt;/span&gt; ./build-key client
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Copie o arquivo de configura√ß√£o do OpenSSL com vers√£o, openssl-1.0.0.cnf, para um nome sem vers√£o, openssl.cnf. N√£o fazer isso pode resultar em um erro em que o OpenSSL n√£o consegue carregar a configura√ß√£o porque n√£o pode detectar sua vers√£o&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; cp /etc/openvpn/easy-rsa/openssl-1.0.0.cnf /etc/openvpn/easy-rsa/openssl.cnf
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Iniciando OpenVPN&lt;/h3&gt;
&lt;p&gt;Vamos configurar o OpenVPN para iniciar na inicializa√ß√£o. Para fazer isso, ative o servidor OpenVPN adicionando-o ao systemctl&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; sudo systemctl -f &lt;span class="nb"&gt;enable&lt;/span&gt; openvpn@server.service
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Inicie o servi√ßo&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; sudo systemctl start openvpn@server.service
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Verifique se n√£o houve erros durante a inicializa√ß√£o do servi√ßo. Caso tenha erros, verifique o arquivo de log /var/log/openvpn.log&lt;/p&gt;
&lt;h3&gt;Criando rotas estaticas&lt;/h3&gt;
&lt;p&gt;Vamos criar para cada cliente uma configura√ß√£o de rede individual&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; mkdir /etc/openvpn/ccd
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Dentro do diret√≥rio, crie um arquivo com o nome exatamente igual ao que foi gerado o certificado, no nosso caso √© client&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; touch /etc/openvpn/ccd/client
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Vamos inserir as informa√ß√µes necess√°rias.&lt;/p&gt;
&lt;p&gt;[Optional]
Caso deseja que cada cliente tenha um endere√ßo setado manualmente, insira no inicio do arquivo&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="go"&gt;ifconfig-push 10.1.1.1 255.255.255.0 &lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;[/optional]&lt;/p&gt;
&lt;p&gt;Insira as rotas da rede local e a rede openvpn, caso deseja que ele acesse a mesma&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="go"&gt;push &amp;quot;route 10.1.1.0 255.255.255.0&amp;quot;&lt;/span&gt;
&lt;span class="go"&gt;push &amp;quot;route 10.42.12.0 255.255.254.0&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Insira as rotas desejadas, sempre comentando o destino &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; Algum lugar &lt;span class="k"&gt;do&lt;/span&gt; mundo
&lt;span class="go"&gt;push &amp;quot;route 200.200.200.1 255.255.255.0&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Configurando o Firewall&lt;/h3&gt;
&lt;p&gt;Para que o servidor fa√ßa os redirecionamentos necess√°rios e aceite conex√µes precisamos setar isso no iptables&lt;/p&gt;
&lt;p&gt;Execute os seguintes comandos&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="gp"&gt;#&lt;/span&gt; &lt;span class="nb"&gt;echo&lt;/span&gt; &lt;span class="m"&gt;1&lt;/span&gt; &amp;gt; /proc/sys/net/ipv4/ip_forward
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -P FORWARD ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A INPUT -i tun+ -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A FORWARD -i tun+ -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -t nat -A POSTROUTING -o ens32 -j MASQUERADE
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A FORWARD -i tun0 -o tun0 -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A FORWARD -i tun0 -o ens32 -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A FORWARD -i ens32 -o tun0 -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A INPUT -p tcp --dport &lt;span class="m"&gt;1194&lt;/span&gt; -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -A INPUT -p udp --dport &lt;span class="m"&gt;1194&lt;/span&gt; -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -I INPUT -i tun+ -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -I OUTPUT -o tun+ -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -I FORWARD -i tun+ -j ACCEPT
&lt;span class="gp"&gt;#&lt;/span&gt; iptables -I FORWARD -o tun+ -j ACCEPT
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;Configurando o Cliente&lt;/h3&gt;
&lt;p&gt;Os certificados e chave que ser√£o inseridos no final do arquivo se encontram em /etc/openvpn/easy-rsa/keys/
Sendo eles
    * ca - ca.crt 
    * cert - client.crt
    * key - client.key&lt;/p&gt;
&lt;p&gt;Crie o arquivo client.ovpn com as seguintes configura√ß√µes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="go"&gt;client&lt;/span&gt;
&lt;span class="go"&gt;pull&lt;/span&gt;
&lt;span class="go"&gt;dev tun&lt;/span&gt;
&lt;span class="go"&gt;proto udp&lt;/span&gt;
&lt;span class="go"&gt;remote &amp;lt;ip external&amp;gt; 1194 udp&lt;/span&gt;
&lt;span class="go"&gt;user nobody&lt;/span&gt;
&lt;span class="go"&gt;group nogroup&lt;/span&gt;
&lt;span class="go"&gt;comp-lzo&lt;/span&gt;
&lt;span class="go"&gt;verb 3&lt;/span&gt;
&lt;span class="go"&gt;resolv-retry infinite&lt;/span&gt;
&lt;span class="go"&gt;persist-key&lt;/span&gt;
&lt;span class="go"&gt;persist-tun&lt;/span&gt;
&lt;span class="go"&gt;mute-replay-warnings&lt;/span&gt;
&lt;span class="go"&gt;auth-nocache&lt;/span&gt;
&lt;span class="go"&gt;float&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Ciphers
&lt;span class="go"&gt;remote-cert-tls server&lt;/span&gt;
&lt;span class="go"&gt;tls-version-min 1.2&lt;/span&gt;
&lt;span class="go"&gt;tls-cipher TLS-DHE-RSA-WITH-AES-256-GCM-SHA384&lt;/span&gt;
&lt;span class="go"&gt;cipher AES-256-CBC&lt;/span&gt;

&lt;span class="gp"&gt;#&lt;/span&gt; Client Keys
&lt;span class="go"&gt;&amp;lt;ca&amp;gt;&lt;/span&gt;
&lt;span class="go"&gt;-----BEGIN CERTIFICATE-----&lt;/span&gt;
&lt;span class="go"&gt;-----END CERTIFICATE-----&lt;/span&gt;
&lt;span class="go"&gt;&amp;lt;/ca&amp;gt;&lt;/span&gt;
&lt;span class="go"&gt;&amp;lt;cert&amp;gt;&lt;/span&gt;
&lt;span class="go"&gt;-----BEGIN CERTIFICATE-----&lt;/span&gt;
&lt;span class="go"&gt;-----END CERTIFICATE-----&lt;/span&gt;
&lt;span class="go"&gt;&amp;lt;/cert&amp;gt;&lt;/span&gt;
&lt;span class="go"&gt;&amp;lt;key&amp;gt;&lt;/span&gt;
&lt;span class="go"&gt;-----BEGIN RSA PRIVATE KEY-----&lt;/span&gt;
&lt;span class="go"&gt;-----END RSA PRIVATE KEY-----&lt;/span&gt;
&lt;span class="go"&gt;&amp;lt;/key&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Copie o arquivo para sua m√°quina local, pode utilizar sftp ou scp. &lt;/p&gt;
&lt;p&gt;Ap√≥s seguir esses passos, sua vpn dever√° estar j√° criada e acess√≠vel. Realize os testes de acesso, sempre verificando os logs.&lt;/p&gt;
&lt;p&gt;Simples Assim üòÜ&lt;/p&gt;</content><category term="sysadmin"></category><category term="VPN"></category><category term="Linux"></category></entry><entry><title>Monitorar conexoes</title><link href="https://blog.chcdc.com.br/posts/monitorar-conexoes" rel="alternate"></link><published>2016-07-20T04:06:37-03:00</published><updated>2016-07-20T04:06:37-03:00</updated><author><name>Carlos Carvalho</name></author><id>tag:blog.chcdc.com.br,2016-07-20:/posts/monitorar-conexoes</id><summary type="html">&lt;p&gt;O tcpdump √© um famoso sniffer para sistemas Linux. Muito util para analise  e solu√ß√£o de problemas da rede.&lt;/p&gt;</summary><content type="html">&lt;p&gt;O tcpdump √© um famoso sniffer para sistemas Linux. Muito util para analise  e solu√ß√£o de problemas da rede.&lt;/p&gt;
&lt;p&gt;Sua documenta√ß√£o pode ser encontrada no site oficial.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.tcpdump.org"&gt;TCPDUMP&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;A maioria das distribui√ß√µes linux possuem binarios, caso n√£o possua, sua instala√ß√£o √© bem simples.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    sudo apt-get install tcpdump
&lt;/pre&gt;&lt;/div&gt;


&lt;!--more--&gt;

&lt;p&gt;Inicialmente n√£o √© necessario um parametro para sua execu√ß√£o, voc√™ apenas precisa executar como root, pois o tcpdump ir√° colocar sua placa de rede em modo promiscuo.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Por√©m podemos utilizar diversos filtros por meio de parametros&lt;/p&gt;
&lt;p&gt;Por padr√£o ele faz a captura da placa de rede ativa.Para selecionar a placa, devemos utilizar o parametro -i seguido da placa a ser monitorada&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Podemos monitorar conexoes de origem utilizando o parametro &lt;em&gt;-src host&lt;/em&gt;. Tudo que vier do nosso gateway (192.168.1.1) para o nosso computador ( 192.168.1.10 ), ser√° monitorado com o seguinte comando&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0 src &lt;span class="m"&gt;192&lt;/span&gt;.168.1.1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Se quisermos monitorar da forma inversa.Tudo que sair de nosso computador (192.168.1.10) para o nosso gateway, o comando ser√° o seguinte&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0 dst &lt;span class="m"&gt;192&lt;/span&gt;.168.1.1
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Tamb√©m √© possivel especificar a porta de origem e destino com o comando &lt;em&gt;src port&lt;/em&gt; e &lt;em&gt;dst port&lt;/em&gt; . Um exemplo √© monitorar a porta 443&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0 dst port &lt;span class="m"&gt;443&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Para que o tcpdump n√£o converta os endere√ßos e portas, devemos utilizar o parametro &lt;em&gt;-n&lt;/em&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0 -n host www.google.com.br
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Podemos tambem utilizar operadores booleanos para um filtro mais refinado.&lt;/p&gt;
&lt;p&gt;Por exemplo, capturar todos os pacotes da porta 80 e 443 da rede 192.168.1.0/16&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;    tcpdump -i eth0 -n net &lt;span class="m"&gt;192&lt;/span&gt;.168 and port &lt;span class="m"&gt;80&lt;/span&gt; and port &lt;span class="m"&gt;443&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Muitas op√ß√µes podem ser obtidas com o tcpdump, essas s√£o algumas op√ß√µes basicas pra iniciar com sniffers.&lt;/p&gt;</content></entry></feed>